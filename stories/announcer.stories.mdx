import { createHistory, Link, LocationProvider, Router } from "@reach/router";
import { ArgsTable, Canvas, Meta, Story, Subtitle } from "@storybook/addon-docs/blocks";
import { RouteAnnouncer } from "../src/components/announcer/route-announcer";

<Meta
	title="Feedback/Announcer"
	component={RouteAnnouncer}
	parameters={{
		previewTabs: {
			"storybook/docs/panel": {
				hidden: true,
			},
		},
	}}
/>

<style>{`
	.page {
		width: 100%;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		font-family: sans-serif;
		background: black;
		color: white;
		padding: 2rem;
	}

	.inner {
		padding: 2rem 0;
	}

	a {
		color: white;
		text-decoration: none;
	}

	.nav {
		display: flex;
		flex-direction: row;
		gap: 1rem;
	}

	a[aria-current="page"] {
		text-decoration: underline;
	}

	.footer {
		width: 100%;
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		justify-content: space-around;
		gap: 2rem;
	}

	.footer__list {
		margin: 0;
		padding: 0;
		list-style-type: none;
		display: grid;
		grid-gap: 1rem;
	}

	.footer__link {
		border-bottom: 1px solid #fff;
	}
`}</style>

export let history = createHistory(window);

export const Home = () => (
	<div className="page inner">
		<h1>Welcome</h1>
		<p>You are on the welcome page</p>
	</div>
);

export const Dashboard = () => (
	<div className="page inner">
		<h1>Dashboard</h1>
		<p>You are on the dashboard page</p>
	</div>
);

export const Invoice = (props) => (
	<div className="page inner">
		<h1>Invoice {props.invoiceId}</h1>
		<p>You are on the invoice page</p>
	</div>
);

export const DemoWithRouter = () => {
	return (
		<LocationProvider history={history}>
			{(context) => {
				return (
					<div className="page">
						<RouteAnnouncer pathname={context.location.pathname}>
							<header>
								<nav className="nav">
									<Link to="/">Home</Link>
									<Link to="/dashboard">Dashboard</Link>
									<Link to="/invoices/123">Invoice 123</Link>
									<Link to="/invoices/abc">Invoice ABC</Link>
								</nav>
							</header>
							<main>
								<Router>
									<Home path="/" />
									<Dashboard path="/dashboard" />
									<Invoice path="/invoices/:invoiceId" />
								</Router>
							</main>
							<footer className="footer">
								<div className="footer__column">
									<h5>Features</h5>
									<ul className="footer__list">
										<li>
											<a className="footer__link" href="#">
												Cool stuff
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Random feature
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Team feature
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Stuff for developers
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Another one
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Last time
											</a>
										</li>
									</ul>
								</div>
								<div className="footer__column">
									<h5>Resources</h5>
									<ul className="footer__list">
										<li>
											<a className="footer__link" href="#">
												Resource name
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Resource
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Another resource
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Final resource
											</a>
										</li>
									</ul>
								</div>
								<div className="footer__column">
									<h5>Resources</h5>
									<ul className="footer__list">
										<li>
											<a className="footer__link" href="#">
												Business
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Education
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Government
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Gaming
											</a>
										</li>
									</ul>
								</div>
								<div className="footer__column">
									<h5>About</h5>
									<ul className="footer__list">
										<li>
											<a className="footer__link" href="#">
												Team
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Locations
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Privacy
											</a>
										</li>
										<li>
											<a className="footer__link" href="#">
												Terms
											</a>
										</li>
									</ul>
								</div>
							</footer>
						</RouteAnnouncer>
					</div>
				);
			}}
		</LocationProvider>
	);
};

# Announcer

<Subtitle>Announces client-side changes for assistive technologies.</Subtitle>

## Introduction

Despite the fact that the process of building single-page web applications has come a long way, some accessibility aspects are left out of consideration when using React or React-based frameworks.
One of these aspects is focus management and route changes announcements being available to screen-reader users.

It so happens that, with "traditional" web pages, each time the user navigates to another page, the screen-reader announces that and it's been like this for the last 20 years.

It just works.

However, with the advent of single-page apps, this does not happen when using javascript to handle page routing. As this is not a concern for most common react-router authors, it's not a default setting.

This accessibility violation also happens on pages that use javascript to add or remove content to/from the DOM.
For instance, common tasks such as form filling, validation and submission are most of the time left out.

Hence, there are these huge accessibility barriers being raised for users that rely on these assistive technologies. And besides that, it violates one of the ten general usability heuristics for the web - "Visibility of system status".

If the user is not informed that a change has occurred whilst operating the system, how will it know what to expect and where to navigate?

For pointing-device users, this may not seem like a huge design flaw. However, for those that rely on assistive technologies, this is a no-deal breaker.

## Route Announcer

The `RouteAnnouncer` adds an ARIA live region that announces route changes.

It stands at the top of the component React tree (preferably, first or second rendered component) and listens for a change on the location's `pathname` (eg. Going from `/events` to `/contacts`).

The rest of the content is placed inside a wrapper, alongside the ARIA live region HTML element.

Whenever the location changes, it adds a message onto that HTML element, thus triggering the screen-reader and make it read it's text content out loud (eg: `Navigated to Events`).
To avoid the user having to manually insert the message everytime the location changes, it queries the DOM for common elements and patterns that might signal something that can identify the new page.
These are: `h1` headings (there should be only one per page), text content inside the `title` tag in the `head` element or, as a fallback, the pathname itself.

<Canvas>
	<Story
		name="Route Announcer"
		height="50vh"
		inline
		args={{
			pathname: "/",
		}}
	>
		{() => <DemoWithRouter />}
	</Story>
</Canvas>

### Props

<ArgsTable story="Route Announcer" />

### Usage

#### Using Next.js

#### Using `@reach/router`

#### Using `react-router`

### Compatibility

## Messages Announcer

As said before, with single-page webapps it is common that very important changes happening aren completely ignored by screen readers.
This happens because we are manipulating the DOM with JavasScript and screen readers look for the focus events and not these changes.

Like the `RouteAnnouncer`, with the `Messages` announcer we create an ARIA live region that, if found by a screen reader, will be monitored and any changes to the content will be announced to the user.

<Canvas>
	<Story
		name="Messages Announcer"
		args={{
			pathname: window.location.pathname,
		}}
	>
		{() => <DemoWithRouter />}
	</Story>
</Canvas>

### Props

<ArgsTable story="Messages Announcer" />

### Usage

The component takes advantage of React's `context` api, so that we can use the updater function anywhere inside the `MessagesAnnouncer` children.

### With Functional Components

To send messages inside a functional component, you can take advantage of the `useMessageAnnouncer` custom hook.

First import the hook at the top of the file:

```jsx
import { useMessageAnnouncer } from "react-a11y-tools";
```

Then, after you've defined your component, save the hook to a constant:

```jsx
const setMessage = useMessageAnnouncer();
```

Finally, use the function whenever you'd like to announce something.

```jsx
function onClick() {
	setMessage("The user has performed an action that it will be announced!");
}

return (
	<button type="button" onClick={onClick}>
		Send Message
	</button>
);
```

#### Forms

You can use component to wrap the contents of a form, for instance.
This is render the form and, alongside it, the ARIA live region.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<MessagesAnnouncer>
		<form>
			...
		</form>
	</MessagesAnnouncer>
);
```

#### Global usage

In order to have the announcer available for the whole app, consider wrapping the content with it.
This way you can access the `setMessage` function in any component.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<MessagesAnnouncer>
		<YourApp />
	</MessagesAnnouncer>
);
```

#### With Route Announcer

You can use the `MessageAnnouncer` along with the `RouteAnnouncer`.
However, it is advised that you still place the `RouteAnnouncer` at the top and then inside it, the `MessageAnnouncer`.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<RouteAnnouncer pathname={pathname}>
		<MessagesAnnouncer>
			<YourApp />
		</MessagesAnnouncer>
	</RouteAnnouncer>
);
```

### Compatibility
