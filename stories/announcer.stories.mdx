import { useState } from "react";
import { createHistory, Link, LocationProvider, Router } from "@reach/router";
import { ArgsTable, Canvas, Meta, Story, Subtitle } from "@storybook/addon-docs/blocks";
import { color } from "@storybook/theming";
import styled from "@emotion/styled";
import { RouteAnnouncer } from "../src/components/announcer/route-announcer";
import { MessagesAnnouncer, useMessagesAnnouncer } from "../src/components/announcer/messages";

<Meta title="Feedback/Announcer" component={RouteAnnouncer} />

export const Page = styled.div`
	display: flex;
	flex-direction: column;
	justify-content: flex-start;
	font-family: sans-serif;
	background: #000a12;
	color: white;
	padding: 2rem;
`;

export const Footer = styled.footer`
	padding: 0 2rem;
	width: 100%;
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	justify-content: space-around;
	gap: 2rem;
`;

export const FooterList = styled.ul`
	margin: 0;
	padding: 0;
	list-style-type: none;
	display: grid;
	grid-gap: 1rem;
`;

export const Anchor = styled(Link)`
	color: white;
	text-decoration: none;
	outline-offset: 8px;
	&[aria-current="page"] {
		text-decoration: underline;
		text-decoration-color: white;
	}
	&:focus {
		outline: 1px solid ${color.secondary};
	}
`;

export const FooterLink = styled.a`
	color: white;
	text-decoration: none;
	&:focus {
		text-decoration: underline;
		outline: 1px solid ${color.secondary};
	}
`;

export const Nav = styled.nav`
	padding: 0 2rem;
	display: flex;
	flex-direction: row;
	gap: 1rem;
`;

export const PageWrapper = styled.div`
	background: #ddeefc;
	font-family: sans-serif;
	font-size: 16px;
	* {
		box-sizing: border-box;
	}
`;

export const Card = styled.div`
	max-width: 570px;
	min-width: 490px;
	margin: 0 auto;
	padding-top: 50px;
	padding-bottom: 70px;
	width: 100%;
`;

export const CardInputs = styled.div`
	background: #fff;
	box-shadow: 0 30px 60px 0 rgba(90, 116, 148, 0.4);
	border-radius: 10px;
`;

export const CardForm = styled.form`
	margin: 0 auto;
	padding: 40px;
	fieldset {
		border: none;
		display: grid;
		grid-gap: 16px;
		grid-template-columns: 1fr 2fr 1fr;
		width: 100%;
	}
	legend {
		font-size: 24px;
		font-weight: bold;
		width: 100%;
		grid-column: 1/4;
	}
	.lg-input {
		grid-column: 1 / 4;
	}
	.med-input {
		grid-column: 1 / 3;
	}
	.sm-input {
		grid-column: 3 / 4;
	}
	label {
		display: block;
		font-size: 14px;
		margin-bottom: 5px;
		font-weight: 500;
		color: #1a3b5d;
		width: 100%;
		display: block;
		user-select: none;
	}
	.name-input,
	.number-input,
	.cvv-input {
		width: 100%;
	}
	.month-input,
	.year-input {
		width: 44%;
		margin-right: 16px;
	}
	input,
	select {
		height: 50px;
		border-radius: 5px;
		border: 1px solid #ced6e0;
		box-shadow: none;
		font-size: 18px;
		padding: 5px 16px;
		background: none;
		color: #1a3b5d;
		font-family: sans-serif;
		transition: all 0.3s ease-in-out;
		letter-spacing: 1px;
		&:hover,
		&:focus {
			border-color: #3d9cff;
		}
		&:focus {
			box-shadow: 0px 10px 20px -13px rgba(32, 56, 117, 0.35);
		}
	}
	select {
		appearance: none;
		background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAeCAYAAABuUU38AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUxJREFUeNrM1sEJwkAQBdCsngXPHsQO9O5FS7AAMVYgdqAd2IGCDWgFnryLFQiCZ8EGnJUNimiyM/tnk4HNEAg/8y6ZmMRVqz9eUJvRaSbvutCZ347bXVJy/ZnvTmdJ862Me+hAbZCTs6GHpyUi1tTSvPnqTpoWZPUa7W7ncT3vK4h4zVejy8QzM3WhVUO8ykI6jOxoGA4ig3BLHcNFSCGqGAkig2yqgpEiMsjSfY9LxYQg7L6r0X6wS29YJiYQYecemY+wHrXD1+bklGhpAhBDeu/JfIVGxaAQ9sb8CI+CQSJ+QmJg0Ii/EE2MBiIXooHRQhRCkBhNhBcEhLkwf05ZCG8ICCOpk0MULmvDSY2M8UawIRExLIQIEgHDRoghihgRIgiigBEjgiFATBACAgFgghEwSAAGgoBCBBgYAg5hYKAIFYgHBo6w9RRgAFfy160QuV8NAAAAAElFTkSuQmCC");
		background-size: 12px;
		background-position: 90% center;
		background-repeat: no-repeat;
		padding-right: 30px;
	}
	button {
		height: 55px;
		background: #2364d2;
		border: none;
		border-radius: 5px;
		font-size: 22px;
		font-weight: 500;
		font-family: sans-serif;
		box-shadow: 3px 10px 20px 0px rgba(35, 100, 210, 0.3);
		color: #fff;
		margin-top: 20px;
		cursor: pointer;
		transition: all 0.3s ease-in-out;
	}
`;

export const ErrorMessage = styled.p`
	width: 100%;
	background-color: hsla(134deg 57% 45% / 28%);
	border: 2px solid hsl(134deg 54% 34%);
	color: #0a1818;
	margin-top: 2rem;
	border-radius: 5px;
	padding: 0.5rem 1.5rem;
	text-align: center;
`;

export let history = createHistory(window);

export const Home = () => (
	<Page>
		<h1>Welcome</h1>
		<p>You are on the welcome page</p>
	</Page>
);

export const Dashboard = () => (
	<Page>
		<h1>Dashboard</h1>
		<p>You are on the dashboard page</p>
	</Page>
);

export const Invoice = (props) => (
	<Page>
		<h1>Invoice {props.invoiceId}</h1>
		<p>You are on the invoice page</p>
	</Page>
);

export const DemoWithRouter = () => {
	return (
		<LocationProvider history={history}>
			{(context) => {
				return (
					<Page>
						<RouteAnnouncer pathname={context.location.pathname}>
							<header>
								<Nav className="nav">
									<Anchor to="/">Home</Anchor>
									<Anchor to="/dashboard">Dashboard</Anchor>
									<Anchor to="/invoices/123">Invoice 123</Anchor>
									<Anchor to="/invoices/abc">Invoice ABC</Anchor>
								</Nav>
							</header>
							<main>
								<Router>
									<Home path="/" />
									<Dashboard path="/dashboard" />
									<Invoice path="/invoices/:invoiceId" />
								</Router>
							</main>
							<Footer>
								<div className="footer__column">
									<h5>Features</h5>
									<FooterList>
										<li>
											<FooterLink className="footer__link" href="#">
												Cool stuff
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Random feature
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Team feature
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Stuff for developers
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Another one
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Last time
											</FooterLink>
										</li>
									</FooterList>
								</div>
								<div className="footer__column">
									<h5>Resources</h5>
									<FooterList className="footer__list">
										<li>
											<FooterLink className="footer__link" href="#">
												Resource name
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Resource
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Another resource
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Final resource
											</FooterLink>
										</li>
									</FooterList>
								</div>
								<div className="footer__column">
									<h5>Resources</h5>
									<FooterList className="footer__list">
										<li>
											<FooterLink className="footer__link" href="#">
												Business
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Education
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Government
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Gaming
											</FooterLink>
										</li>
									</FooterList>
								</div>
								<div className="footer__column">
									<h5>About</h5>
									<FooterList className="footer__list">
										<li>
											<FooterLink className="footer__link" href="#">
												Team
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Locations
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Privacy
											</FooterLink>
										</li>
										<li>
											<FooterLink className="footer__link" href="#">
												Terms
											</FooterLink>
										</li>
									</FooterList>
								</div>
							</Footer>
						</RouteAnnouncer>
					</Page>
				);
			}}
		</LocationProvider>
	);
};

export const DemoMessagesAnnouncer = () => {
	const [hasSubmitted, setHasSubmitted] = useState(false);
	function handleOnSubmit() {
		setHasSubmitted(true);
	}
	return (
		<MessagesAnnouncer>
			<PageWrapper>
				<Card className="card-form">
					<CardInputs className="card-inputs">
						<DemoForm hasSubmitted={hasSubmitted} onSubmit={handleOnSubmit} />
					</CardInputs>
				</Card>
			</PageWrapper>
		</MessagesAnnouncer>
	);
};

export const DemoForm = ({ hasSubmitted, onSubmit }) => {
	const setMessage = useMessagesAnnouncer();
	function handleOnSubmit(event) {
		event.preventDefault();
		setTimeout(() => {
			onSubmit(true);
			setMessage({
				text: "The money it's on the way! Thank you!",
				politeness: "assertive",
			});
		}, 1000);
	}
	return (
		<CardForm onSubmit={handleOnSubmit}>
			<fieldset>
				<legend>Credit Card Form</legend>
				<div className="lg-input">
					<label htmlFor="cardNumber">Card Number</label>
					<input
						className="number-input"
						id="cardNumber"
						maxLength={19}
						style={{
							backgroundRepeat: "no-repeat",
							backgroundAttachment: "scroll",
							backgroundSize: "16px 18px",
							backgroundPosition: "98% 50%",
							cursor: "auto",
						}}
						type="text"
						defaultValue="4111111111111111"
					/>
				</div>
				<div className="lg-input">
					<label htmlFor="cardName">Card Holder's Name</label>
					<input className="name-input" id="cardName" maxLength={24} type="text" defaultValue="João Dias" />
				</div>
				<div className="med-input">
					<label htmlFor="cardMonth">Expiration Date</label>
					<select className="month-input" id="cardMonth">
						<option disabled value={8}>
							Month
						</option>
						<option value={1}>01</option>
						<option value={2}>02</option>
						<option value={3}>03</option>
						<option value={4}>04</option>
						<option value={5}>05</option>
						<option value={6}>06</option>
						<option value={7}>07</option>
						<option value={8}>08</option>
						<option value={9}>09</option>
						<option value={10}>10</option>
						<option value={11}>11</option>
						<option value={12}>12</option>
					</select>
					<select className="year-input" id="cardYear">
						<option disabled value={0}>
							Year
						</option>
						<option value={2021}>2021</option>
						<option value={2022}>2022</option>
						<option value={2023}>2023</option>
						<option value={2024}>2024</option>
						<option value={2025}>2025</option>
						<option value={2026}>2026</option>
						<option value={2027}>2027</option>
						<option value={2028}>2028</option>
						<option value={2029}>2029</option>
						<option value={2030}>2030</option>
						<option value={2031}>2031</option>
						<option value={2032}>2032</option>
						<option value={2033}>2033</option>
					</select>
				</div>
				<div className="sm-input">
					<label htmlFor="cardCvv">CVV</label>
					<input className="cvv-input" id="cardCvv" maxLength={3} defaultValue="123" />
				</div>
				<button type="submit" className="lg-input">
					Pay 9.99€
				</button>
			</fieldset>
			{hasSubmitted && (
				<fieldset>
					<ErrorMessage>Sent!</ErrorMessage>
				</fieldset>
			)}
		</CardForm>
	);
};

# Announcer

<Subtitle>Announces client-side changes for assistive technologies.</Subtitle>

## Introduction

Despite the fact that the process of building single-page web applications has come a long way, some accessibility aspects are left out of consideration when using React or React-based frameworks.
One of these aspects is focus management and route changes announcements being available to screen-reader users.

It so happens that, with "traditional" web pages, each time the user navigates to another page, the screen-reader announces that and it's been like this for the last 20 years.

It just works.

However, with the advent of single-page apps, this does not happen when using javascript to handle page routing. As this is not a concern for most common react-router authors, it's not a default setting.

This accessibility violation also happens on pages that use javascript to add or remove content to/from the DOM.
For instance, common tasks such as form filling, validation and submission are most of the time left out.

Hence, there are these huge accessibility barriers being raised for users that rely on these assistive technologies. And besides that, it violates one of the ten general usability heuristics for the web - "Visibility of system status".

If the user is not informed that a change has occurred whilst operating the system, how will it know what to expect and where to navigate?

For pointing-device users, this may not seem like a huge design flaw. However, for those that rely on assistive technologies, this is a no-deal breaker.

## Route Announcer

The `RouteAnnouncer` adds an ARIA live region that announces route changes.

It stands at the top of the component React tree (preferably, first or second rendered component) and listens for a change on the location's `pathname` (eg. Going from `/events` to `/contacts`).

The rest of the content is placed inside a wrapper, alongside the ARIA live region HTML element.

Whenever the location changes, it adds a message onto that HTML element, thus triggering the screen-reader and make it read it's text content out loud (eg: `Navigated to Events`).
To avoid the user having to manually insert the message everytime the location changes, it queries the DOM for common elements and patterns that might signal something that can identify the new page.
These are: `h1` headings (there should be only one per page), text content inside the `title` tag in the `head` element or, as a fallback, the pathname itself.

<Canvas>
	<Story
		name="Route Announcer"
		height="50vh"
		inline
		args={{
			pathname: "/",
		}}
	>
		{() => <DemoWithRouter />}
	</Story>
</Canvas>

### Props

<ArgsTable story="Route Announcer" />

### Usage

#### Using Next.js

#### Using `@reach/router`

#### Using `react-router`

### Compatibility

## Messages Announcer

As said before, with single-page webapps it is common that very important changes happening aren completely ignored by screen readers.
This happens because we are manipulating the DOM with JavasScript and screen readers look for the focus events and not these changes.

Like the `RouteAnnouncer`, with the `Messages` announcer we create an ARIA live region that, if found by a screen reader, will be monitored and any changes to the content will be announced to the user.

<Canvas>
	<Story name="Messages Announcer">
		<DemoMessagesAnnouncer />
	</Story>
</Canvas>

### Props

<ArgsTable story="Messages Announcer" />

### Usage

The component takes advantage of React's `context` api, so that we can use the updater function anywhere inside the `MessagesAnnouncer` children.

### With Functional Components

To send messages inside a functional component, you can take advantage of the `useMessageAnnouncer` custom hook.

First import the hook at the top of the file:

```jsx
import { useMessageAnnouncer } from "react-a11y-tools";
```

Then, after you've defined your component, save the hook to a constant:

```jsx
const setMessage = useMessageAnnouncer();
```

Finally, use the function whenever you'd like to announce something.

```jsx
function onClick() {
	setMessage("The user has performed an action that it will be announced!");
}

return (
	<button type="button" onClick={onClick}>
		Send Message
	</button>
);
```

#### Forms

You can use component to wrap the contents of a form, for instance.
This is render the form and, alongside it, the ARIA live region.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<MessagesAnnouncer>
		<form>
			...
		</form>
	</MessagesAnnouncer>
);
```

#### Global usage

In order to have the announcer available for the whole app, consider wrapping the content with it.
This way you can access the `setMessage` function in any component.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<MessagesAnnouncer>
		<YourApp />
	</MessagesAnnouncer>
);
```

#### With Route Announcer

You can use the `MessageAnnouncer` along with the `RouteAnnouncer`.
However, it is advised that you still place the `RouteAnnouncer` at the top and then inside it, the `MessageAnnouncer`.

```jsx
import { MessagesAnnouncer } from "react-a11y-tools";
...
return (
	<RouteAnnouncer pathname={pathname}>
		<MessagesAnnouncer>
			<YourApp />
		</MessagesAnnouncer>
	</RouteAnnouncer>
);
```

### Compatibility
